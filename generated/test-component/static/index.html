<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCP Factory — test-component</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --accent: #58a6ff; --user-bg: #1f6feb; --tool-bg: #1a3a1a;
    --text: #c9d1d9; --muted: #8b949e; --error: #f85149;
    --radius: 10px; --font: system-ui, -apple-system, sans-serif;
  }
  body { background: var(--bg); color: var(--text); font-family: var(--font);
         display: flex; flex-direction: column; height: 100dvh; }
  header { background: var(--surface); border-bottom: 1px solid var(--border);
           padding: 12px 20px; display: flex; align-items: center;
           justify-content: space-between; flex-shrink: 0; }
  header h1 { font-size: 1rem; font-weight: 600; color: var(--accent); }
  header span { font-size: .8rem; color: var(--muted); }
  #download-btn {
    background: var(--surface); border: 1px solid var(--border); color: var(--accent);
    padding: 5px 14px; border-radius: 6px; cursor: pointer; font-size: .8rem;
    text-decoration: none; transition: background .15s;
  }
  #download-btn:hover { background: var(--border); }
  #chat-window { flex: 1; overflow-y: auto; padding: 20px;
                 display: flex; flex-direction: column; gap: 12px; }
  .bubble { max-width: 75%; padding: 10px 14px; border-radius: var(--radius);
            line-height: 1.5; font-size: .9rem; white-space: pre-wrap; word-break: break-word; }
  .bubble.user { background: var(--user-bg); align-self: flex-end;
                 border-bottom-right-radius: 3px; }
  .bubble.assistant { background: var(--surface); border: 1px solid var(--border);
                       align-self: flex-start; border-bottom-left-radius: 3px; }
  .bubble.error { background: #2d1117; border: 1px solid var(--error);
                   color: var(--error); align-self: flex-start; }
  .tool-block { background: var(--tool-bg); border: 1px solid #2e5c2e;
                border-radius: var(--radius); padding: 10px 14px; font-size: .8rem;
                align-self: flex-start; max-width: 75%; }
  .tool-block .tool-name { color: #3fb950; font-weight: 600; margin-bottom: 4px; }
  .tool-block .tool-args { color: var(--muted); margin-bottom: 4px; }
  .tool-block .tool-result { color: var(--text); white-space: pre-wrap; word-break: break-word; }
  .typing { align-self: flex-start; color: var(--muted); font-size: .85rem;
            padding: 6px 14px; animation: blink .9s infinite; }
  @keyframes blink { 0%,100% { opacity:.4 } 50% { opacity:1 } }
  footer { background: var(--surface); border-top: 1px solid var(--border);
           padding: 12px 16px; display: flex; gap: 10px; flex-shrink: 0; }
  #msg-input { flex: 1; background: var(--bg); border: 1px solid var(--border);
               color: var(--text); border-radius: 8px; padding: 10px 14px;
               font-size: .9rem; resize: none; height: 44px; line-height: 1.4;
               outline: none; transition: border .15s; }
  #msg-input:focus { border-color: var(--accent); }
  #send-btn { background: var(--accent); color: #000; border: none; border-radius: 8px;
              padding: 0 20px; font-size: .9rem; font-weight: 600; cursor: pointer;
              transition: opacity .15s; }
  #send-btn:disabled { opacity: .4; cursor: not-allowed; }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
<header>
  <h1>MCP Factory &mdash; test-component</h1>
  <div style="display:flex;align-items:center;gap:16px">
    <span id="model-label">model: gpt-4o-mini</span>
    <a id="download-btn" href="/download/invocables" download="selected-invocables.json">
      &#8595; Download invocables.json
    </a>
  </div>
</header>
<div id="chat-window">
  <div class="bubble assistant">
    Hi! I have access to the tools exported by <strong>test-component</strong>.
    Ask me to call a function, describe what one does, or list available tools.
  </div>
</div>
<footer>
  <textarea id="msg-input" placeholder="Ask me to call a function…" rows="1"></textarea>
  <button id="send-btn">Send</button>
</footer>

<script>
  const chatWindow = document.getElementById('chat-window');
  const msgInput   = document.getElementById('msg-input');
  const sendBtn    = document.getElementById('send-btn');
  let history = [];

  function scrollToBottom() {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function appendBubble(cls, text) {
    const d = document.createElement('div');
    d.className = `bubble ${cls}`;
    d.textContent = text;
    chatWindow.appendChild(d);
    scrollToBottom();
    return d;
  }

  function appendToolBlock(t) {
    const d = document.createElement('div');
    d.className = 'tool-block';
    const argsStr = Object.keys(t.args || {}).length
      ? JSON.stringify(t.args, null, 2) : '(no args)';
    d.innerHTML =
      `<div class="tool-name">&#10551; ${t.name}</div>` +
      `<div class="tool-args">args: ${argsStr}</div>` +
      `<div class="tool-result">${t.result}</div>`;
    chatWindow.appendChild(d);
    scrollToBottom();
  }

  function setLoading(v) {
    sendBtn.disabled = v;
    msgInput.disabled = v;
  }

  async function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;
    msgInput.value = '';
    msgInput.style.height = '44px';

    appendBubble('user', text);
    setLoading(true);

    const typing = document.createElement('div');
    typing.className = 'typing';
    typing.textContent = 'Thinking…';
    chatWindow.appendChild(typing);
    scrollToBottom();

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, history }),
      });
      const data = await res.json();
      chatWindow.removeChild(typing);

      if (data.error) {
        appendBubble('error', 'Error: ' + data.error);
      } else {
        (data.tool_outputs || []).forEach(t => appendToolBlock(t));
        appendBubble('assistant', data.reply);
        history = data.updated_history || history;
      }
    } catch (err) {
      chatWindow.removeChild(typing);
      appendBubble('error', 'Network error: ' + err.message);
    }

    setLoading(false);
    msgInput.focus();
  }

  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  msgInput.addEventListener('input', () => {
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
  });

  // Fetch and display model from server env
  fetch('/tools').then(r => r.json()).then(tools => {
    document.getElementById('model-label').textContent =
      `${tools.length} tools loaded`;
  }).catch(() => {});
</script>
</body>
</html>
